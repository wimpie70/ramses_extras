# Ramses Extras - Improvement / Cleanup TODO

> **Testing reminder:** For every task below, evaluate whether we can add or improve tests for the files we touch to keep increasing coverage.
> **Registry reminder:** Changing registries is delicate; keep changes isolated and avoid touching global registries unless strictly required.


## Status: Next (structural / medium risk)

 - [ ] **Clarify the “feature loading” pipeline (there appear to be multiple overlapping mechanisms)**
   - `custom_components/ramses_extras/__init__.py`
     - Loads feature const modules with `load_feature()`.
     - Imports platform modules from each feature’s `platforms/*.py`.
     - Imports feature `websocket_commands` modules.
   - `custom_components/ramses_extras/extras_registry.py`
     - Has its own `load_all_features()`/`load_feature_definitions()` concept.
   - **Goal**
     - Have one authoritative place that:
       - loads feature definitions (configs/mappings)
       - imports platform modules (registration)
       - imports websocket modules (decorators)

 - [ ] **Clarify WebSocket boundary (document + enforce)**
   - Current implementation: decorators live in per-feature modules, explicit registration lives in
     `custom_components/ramses_extras/websocket_integration.py`.
   - **Goal**
     - Decide whether to keep explicit registration (current) or switch to a different pattern.
     - Align `docs/todo.txt` wording with the chosen approach.

## Status: Next (priority)

### High priority (medium risk)

 - [ ] **Handle new devices discovered after restart**
   - Sometimes on restart not all devices are available immediately.
   - New devices may be discovered later by ramses_cc.
   - **Goal**
     - Hook into ramses_cc device discovery method or HA events.
     - Respond to new devices being found and make them available for configuration.
     - Ensure devices discovered after restart can be configured without requiring integration restart.

## Status: Next (cleanup / tech debt)

 - [ ] **Prune unused helpers in `framework/helpers/platform.py`**
   - Candidates:
     - `create_entities_for_device()` (looks unused and contains older logging patterns).
     - `calculate_required_entities()` (seems like debug tooling; verify if used anywhere).
   - Replace ad-hoc debug listing (`_LOGGER.info("Debug: ...")`) with structured debug logs.

 - [ ] **Unify feature constants shape**
   - Today features expose varying const structures:
     - `features/default/const.py` uses `DEFAULT_CONST`.
     - `features/hello_world/const.py` uses `HELLO_WORLD_CONST` but still has placeholder configs.
     - `features/humidity_control/const.py` uses `HUMIDITY_CONTROL_CONST`.
   - Goal: one convention for:
     - `FEATURE_ID`
     - `required_entities`
     - cards config
     - WS command metadata (if kept)

## new: fix 2025-12-28 10:03:52.587 WARNING (MainThread) [homeassistant.helpers.frame] Detected that custom integration 'ramses_extras' calls `async_track_state_change` instead of `async_track_state_change_event` which is deprecated and will be removed in Home Assistant 2025.5 at custom_components/ramses_extras/framework/base_classes/base_automation.py, line 252: listener = async_track_state_change(. Please report it to the author of the 'ramses_extras' custom integration

## Sensor control improvements (Later)

 - [ ] **External calculated absolute humidity entities / multi-sensor strategy**
   - Scenario: multiple temp/humidity sensors for one fan (bathroom + kitchen).
   - Desired behaviour:
     - If any zone spikes, ventilate high for N minutes (handshake with automation).
     - Need OR / max logic and a cooldown / decay strategy.
   - Ideas to explore:
     - Add “aggregation strategy” per device (max/avg/weighted) for resolved metrics.
     - Make Humidity Control consume an abstract “effective abs humidity” that can switch sources.


## Developer experience (Later)

 - [ ] **Add an explicit “Framework API surface” doc section**
   - What helpers are stable for features to call (PlatformSetup, CardRegistry, SensorControlResolver, etc.).
 - [ ] **Add a cleanup test**
   - A unit test asserting there are no duplicate registries / unused registries for WS.
