# Ramses Extras - Improvement / Cleanup TODO

> **Testing reminder:** For every task below, evaluate whether we can add or improve tests for the files we touch to keep increasing coverage.
> **Registry reminder:** Changing registries is delicate; keep changes isolated and avoid touching global registries unless strictly required.



## Status: Next (priority)

### High priority (medium risk)

 - [ ] **Handle new devices discovered after restart**
   - Sometimes on restart not all devices are available immediately.
   - New devices may be discovered later by ramses_cc.
   - **Goal**
     - Hook into ramses_cc device discovery method or HA events.
     - Respond to new devices being found and make them available for configuration.
     - Ensure devices discovered after restart can be configured without requiring integration restart.

## Status: Next (cleanup / tech debt)

 - [ ] **Prune unused helpers in `framework/helpers/platform.py`**
   - Candidates:
     - `create_entities_for_device()` (looks unused and contains older logging patterns).
     - `calculate_required_entities()` (seems like debug tooling; verify if used anywhere).
   - Replace ad-hoc debug listing (`_LOGGER.info("Debug: ...")`) with structured debug logs.

 - [ ] **Unify feature constants shape**
   - Today features expose varying const structures:
     - `features/default/const.py` uses `DEFAULT_CONST`.
     - `features/hello_world/const.py` uses `HELLO_WORLD_CONST` but still has placeholder configs.
     - `features/humidity_control/const.py` uses `HUMIDITY_CONTROL_CONST`.
   - Goal: one convention for:
     - `FEATURE_ID`
     - `required_entities`
     - cards config
     - WS command metadata (if kept)

 - [ ] **Fix HA deprecation: use `async_track_state_change_event`**
   - Home Assistant warns that `async_track_state_change` is deprecated and will be removed.
   - Location: `framework/base_classes/base_automation.py` (listener registration).
   - Goal: migrate to `async_track_state_change_event` without changing automation behavior.

## Sensor control improvements (Later)

 - [ ] **External calculated absolute humidity entities / multi-sensor strategy**
   - Scenario: multiple temp/humidity sensors for one fan (bathroom + kitchen).
   - Desired behaviour:
     - If any zone spikes, ventilate high for N minutes (handshake with automation).
     - Need OR / max logic and a cooldown / decay strategy.
   - Ideas to explore:
     - Add “aggregation strategy” per device (max/avg/weighted) for resolved metrics.
     - Make Humidity Control consume an abstract “effective abs humidity” that can switch sources.


## Developer experience (Later)

 - [ ] **Add an explicit “Framework API surface” doc section**
   - What helpers are stable for features to call (PlatformSetup, CardRegistry, SensorControlResolver, etc.).
 - [ ] **Add a cleanup test**
   - A unit test asserting there are no duplicate registries / unused registries for WS.
