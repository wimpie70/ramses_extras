# Ramses Extras - Improvement / Cleanup TODO

> **Testing reminder:** For every task below, evaluate whether we can add or improve tests for the files we touch to keep increasing coverage.
> **Registry reminder:** Changing registries is delicate; keep changes isolated and avoid touching global registries unless strictly required.



## Status: Next (priority)

### Card deployment & registration refactor (MutationObserver loader)

 - [x] **Define target contract and acceptance criteria (bootstrap loader)**
   - Goal: Only a tiny `main.js` is registered as a Lovelace resource.
   - Cards + editors are loaded on-demand via `import()`.
   - “On-demand” trigger uses `MutationObserver` (load only if a matching element appears).
   - Confirm how we determine “enabled features” in JS (WS call vs config entry options).

 - [x] **Decide asset layout + versioning strategy**
   - Pick one:
     - Versioned directory (e.g. `/local/ramses_extras/vX.Y.Z/...`) to avoid browser cache issues.
     - Stable paths with cache-busting query string (e.g. `main.js?v=X.Y.Z`).
   - Document what is considered “managed” by the integration under `/config/www/ramses_extras/`.

 - [x] **Implement `main.js` bootstrap (minimal runtime)**
   - Loads once, sets up:
     - `MutationObserver` that detects:
       - Known Ramses Extras custom card tags (e.g. `ramses-hvac-fan-card`, `ramses-hello-world`, ...).
       - Editor activation signals (e.g. `hui-card-editor` presence / editor dialog events).
   - For each detected feature/card:
     - `import()` the feature card module once, then disconnect or narrow observer.
   - No top-level imports except tiny helper(s).

 - [x] **Refactor registration flow (Python)**
   - Change CardRegistry registration to register only the bootstrap resource (`main.js`).
   - Keep feature-specific resource registration out of `lovelace_resources`.
   - Ensure the bootstrap resource is added early enough (before dashboards parse).

 - [x] **Asset deployment sync + cleanup on upgrade**
   - Make card deployment idempotent:
     - Copy helpers + feature assets into `/config/www/ramses_extras/...`.
     - Remove stale files that no longer exist in source (or replace the whole managed dir).
   - Handle new versions correctly:
     - If using versioned dirs: delete previous `v*` dirs no longer referenced.
     - If using stable paths: still delete stale feature files to prevent “old card” shadowing.
   - Clean up legacy Lovelace resources:
     - Remove old per-card `lovelace_resources` entries that point to feature JS files.

 - [x] **Testing & validation**
   - Add unit tests for:
     - [x] CardRegistry writes only the bootstrap resource.
     - [x] Deployment cleanup removes stale files safely (in a temp directory).
   - Run `make local-ci`.

## Sensor control improvements (Later)

 - [ ] **External calculated absolute humidity entities / multi-sensor strategy**
   - Scenario: multiple temp/humidity sensors for one fan (bathroom + kitchen).
   - Desired behaviour:
     - If any zone spikes, ventilate high for N minutes (handshake with automation).
     - Need OR / max logic and a cooldown / decay strategy.
   - Ideas to explore:
     - Add “aggregation strategy” per device (max/avg/weighted) for resolved metrics.
     - Make Humidity Control consume an abstract “effective abs humidity” that can switch sources.


## Developer experience (Later)

 - [ ] **Add an explicit “Framework API surface” doc section**
   - What helpers are stable for features to call (PlatformSetup, CardRegistry, SensorControlResolver, etc.).
 - [ ] **Add a cleanup test**
   - A unit test asserting there are no duplicate registries / unused registries for WS.
