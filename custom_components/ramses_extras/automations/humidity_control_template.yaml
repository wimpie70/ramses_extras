# Ramses Extras - Humidity Control Automation Template
# This template creates automation for humidity monitoring and dehumidifier control
# The integration will substitute the correct device_id and entity names

# === RAMSES EXTRAS AUTOMATIONS - DO NOT EDIT ===
# These automations are managed by the Ramses Extras integration
# They will be updated automatically when the integration configuration changes

- id: "ramses_extras_dehumidifier_control_{{ device_id }}"
  alias: "Dehumidifier Control - {{ device_id }}"
  description: "Controls dehumidifier based on humidity thresholds for device {{ device_id }}"
  triggers:
    # Trigger when dehumidify switch is turned on/off
    - platform: state
      entity_id: "switch.dehumidify_{{ device_id_underscore }}"
      to: "on"
    - platform: state
      entity_id: "switch.dehumidify_{{ device_id_underscore }}"
      to: ["off", "unavailable"]
    # Trigger when indoor humidity changes
    - platform: state
      entity_id: "sensor.indoor_absolute_humidity_{{ device_id_underscore }}"
    # Trigger when outdoor humidity changes
    - platform: state
      entity_id: "sensor.outdoor_absolute_humidity_{{ device_id_underscore }}"
    # Trigger when humidity offset setting changes
    - platform: state
      entity_id: "number.absolute_humidity_offset_{{ device_id_underscore }}"
  actions:
    - if:
        - condition: state
          entity_id: "switch.dehumidify_{{ device_id_underscore }}"
          state: "on"
      then:
        # Set binary sensor to active when switch is turned on
        - service: ramses_extras.set_dehumidifying_active
          data:
            entity_id: "binary_sensor.dehumidifying_active_{{ device_id_underscore }}"
            active: true
        # Control fan speed based on humidity conditions
        - if:
            - condition: template
              value_template: "{{ states('sensor.indoor_absolute_humidity_{{ device_id_underscore }}') | float > states('sensor.outdoor_absolute_humidity_{{ device_id_underscore }}') | float + states('number.absolute_humidity_offset_{{ device_id_underscore }}') | float }}"
          then:
            - service: ramses_extras.set_fan_speed_mode
              data:
                device_id: "{{ device_id }}"
                mode: "high"
                reason: "Humidity control - high humidity detected, dryer outside"
        - if:
            - condition: template
              value_template: "{{ states('sensor.indoor_absolute_humidity_{{ device_id_underscore }}') | float <= states('sensor.outdoor_absolute_humidity_{{ device_id_underscore }}') | float }}"
          then:
            - service: ramses_extras.set_fan_speed_mode
              data:
                device_id: "{{ device_id }}"
                mode: "low"
                reason: "Humidity control - high humidity detected, not dryer outside"
    - if:
        - condition: state
          entity_id: "switch.dehumidify_{{ device_id_underscore }}"
          state: ["off", "unavailable"]
      then:
        # Set binary sensor to inactive when switch is turned off
        - service: ramses_extras.set_dehumidifying_active
          data:
            entity_id: "binary_sensor.dehumidifying_active_{{ device_id_underscore }}"
            active: false
        # Set fan back to auto mode when dehumidifier is disabled
        - service: ramses_extras.set_fan_speed_mode
          data:
            device_id: "{{ device_id }}"
            mode: "auto"
            reason: "Humidity control - dehumidifier disabled"

# === END RAMSES EXTRAS AUTOMATIONS ===
