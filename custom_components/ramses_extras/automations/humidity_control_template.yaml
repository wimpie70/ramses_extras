# Ramses Extras - Humidity Control Automation Template
# This template creates automation for humidity monitoring and dehumidifier control
# The integration will substitute the correct device_id and entity names

# === RAMSES EXTRAS AUTOMATIONS - DO NOT EDIT ===
# These automations are managed by the Ramses Extras integration
# They will be updated automatically when the integration configuration changes

automation:
  - id: "ramses_extras_dehumidifier_control_{{ device_id }}"
    alias: "Dehumidifier Control - {{ device_id }}"
    description: "Controls dehumidifier based on humidity thresholds for device {{ device_id }}"
    triggers:
      - platform: numeric_state
        entity_id: "sensor.{{ device_id_underscore }}_indoor_humidity"
        above: "number.{{ device_id_underscore }}_rel_humid_max"
        for:
          minutes: 2
      - platform: numeric_state
        entity_id: "sensor.{{ device_id_underscore }}_indoor_humidity"
        below: "number.{{ device_id_underscore }}_rel_humid_min"
        for:
          minutes: 2
      - platform: state
        entity_id: "switch.dehumidify_{{ device_id_underscore }}"
    conditions:
      - condition: template
        value_template: "{{ is_state('switch.dehumidify_{{ device_id_underscore }}', 'unavailable') == false }}"
    actions:
      - if:
          - condition: template
            value_template: "{{ states('sensor.{{ device_id_underscore }}_indoor_humidity') | float > states('number.{{ device_id_underscore }}_rel_humid_max') | float }}"
        then:
          - service: switch.turn_on
            entity_id: "switch.dehumidify_{{ device_id_underscore }}"
          - service: ramses_cc.set_fan_mode
            data:
              device_id: "{{ device_id }}"
              mode: "high"
          - service: logbook.log
            data:
              name: "Dehumidifier"
              message: "Activated - Humidity {{ states('sensor.{{ device_id_underscore }}_indoor_humidity') }}% > threshold {{ states('number.{{ device_id_underscore }}_rel_humid_max') }}%"
              entity_id: "switch.dehumidify_{{ device_id_underscore }}"
        else:
          - condition: template
            value_template: "{{ states('sensor.{{ device_id_underscore }}_indoor_humidity') | float < states('number.{{ device_id_underscore }}_rel_humid_min') | float }}"
          - service: switch.turn_off
            entity_id: "switch.dehumidify_{{ device_id_underscore }}"
          - service: ramses_cc.set_fan_mode
            data:
              device_id: "{{ device_id }}"
              mode: "auto"
          - service: logbook.log
            data:
              name: "Dehumidifier"
              message: "Deactivated - Humidity {{ states('sensor.{{ device_id_underscore }}_indoor_humidity') }}% < threshold {{ states('number.{{ device_id_underscore }}_rel_humid_min') }}%"
              entity_id: "switch.dehumidify_{{ device_id_underscore }}"

  - id: "ramses_extras_dehumidifier_override_{{ device_id }}"
    alias: "Dehumidifier Manual Override - {{ device_id }}"
    description: "Detects when user manually overrides automatic dehumidifier control"
    triggers:
      - platform: state
        entity_id: "switch.dehumidify_{{ device_id_underscore }}"
        from: "on"
        to: "off"
    conditions:
      - condition: numeric_state
        entity_id: "sensor.{{ device_id_underscore }}_indoor_humidity"
        above: "number.{{ device_id_underscore }}_rel_humid_max"
    actions:
      - service: logbook.log
        data:
          name: "Dehumidifier Override"
          message: "Manual override detected - Dehumidifier turned off despite high humidity ({{ states('sensor.{{ device_id_underscore }}_indoor_humidity') }}%)"
          entity_id: "switch.dehumidify_{{ device_id_underscore }}"

  - id: "ramses_extras_dehumidifier_thresholds_{{ device_id }}"
    alias: "Dehumidifier Default Thresholds - {{ device_id }}"
    description: "Sets default humidity thresholds if not configured"
    triggers:
      - platform: homeassistant
        event: start
      - platform: state
        entity_id: "number.{{ device_id_underscore }}_rel_humid_max"
        to: "unavailable"
        for:
          minutes: 5
    conditions:
      - condition: template
        value_template: "{{ states('number.{{ device_id_underscore }}_rel_humid_max') in ['unknown', 'unavailable', ''] or states('number.{{ device_id_underscore }}_rel_humid_min') in ['unknown', 'unavailable', ''] }}"
    actions:
      - service: number.set_value
        entity_id: "number.{{ device_id_underscore }}_rel_humid_max"
        data:
          value: 75
      - service: number.set_value
        entity_id: "number.{{ device_id_underscore }}_rel_humid_min"
        data:
          value: 50

# === END RAMSES EXTRAS AUTOMATIONS ===
